# Reference this view as main__dim_customers
schema: main
table_name: dim_customers

dimensions:
  first_name: {}
  last_name: {}
  email: {}
  phone: {}
  address_street: {}
  address_city: {}
  address_state: {}
  address_zip: {}
  latitude: {}
  longitude: {}
  preferred_contact_method: {}
  loyalty_tier_color: {}
  loyalty_tier_medal: {}
  lifetime_value: {}
  total_pets: {}
  referral_source: {}
  marketing_opt_in: {}
  last_visit_date: {}
  customer_segment: {}
  account_status: {}

  created_date:
    label: Customer Since

  created_month:
    sql: DATE_TRUNC('month', ${created_date})
    label: Signup Month

  created_year:
    sql: DATE_TRUNC('year', ${created_date})
    label: Signup Year

  full_name:
    sql: ${first_name} || ' ' || ${last_name}
    label: Full Name

  customer_id:
    format: ID
    primary_key: true

measures:
  count:
    aggregate_type: count

  total_customers:
    sql: ${customer_id}
    label: Total Customers
    aggregate_type: count_distinct

  new_customers:
    sql: CASE WHEN ${created_date} >= CURRENT_DATE - INTERVAL '30 days' THEN
      ${customer_id} END
    label: New Customers (30d)
    aggregate_type: count_distinct

  customer_tenure_days:
    sql: DATEDIFF('day', ${created_date}, CURRENT_DATE)
    label: Avg Customer Tenure (days)
    aggregate_type: average

  customers_per_pet:
    sql: CASE WHEN ${main__dim_pets.total_pets} = 0 THEN NULL ELSE
      COALESCE(${main__dim_customers.total_customers}, 0) /
      ${main__dim_pets.total_pets} END
    label: Customers per Pet
